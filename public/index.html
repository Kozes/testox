<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SK AX OX í€´ì¦ˆ</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="header">
      <img src="skax-logo.png" alt="SK AX ë¡œê³ " class="logo" />
      <h1 class="tagline">Imagine, AX</h1>
      <p class="subtagline">HC2 Group TownHall Meeting</p>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
      <!-- í€´ì¦ˆ ì„¹ì…˜ -->
      <div class="quiz-section">
        <!-- ë¬¸ì œ í‘œì‹œ -->
        <div class="question-container">
          <div class="question-label">
            <i class="fas fa-question-circle"></i> í˜„ì¬ ë¬¸ì œ
          </div>
          <div id="question-box" class="question-text">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <!-- ì°¸ì—¬ì ìˆ˜ í‘œì‹œ -->
        <div class="participant-info">
          <div class="status-indicator">
            <div class="status-dot"></div>
            <span>ì‹¤ì‹œê°„ ì—°ê²°ë¨</span>
          </div>
          <p id="participant-count" class="participant-display">í˜„ì¬ ì°¸ì—¬ì ìˆ˜: 0ëª…</p>
        </div>

        <!-- âœ… NEW: ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™© - ì œê±°ë¨ -->

        <!-- ì‚¬ìš©ì ì…ë ¥ -->
        <div class="user-input">
          <input type="text" id="username" class="username-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
        </div>

        <!-- OX ë²„íŠ¼ -->
        <div class="answer-buttons">
          <button onclick="submitAnswer('O')" class="answer-btn o-btn" title="O ì„ íƒ">
            <i class="fas fa-check"></i>
          </button>
          <button onclick="submitAnswer('X')" class="answer-btn x-btn" title="X ì„ íƒ">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- ì •ë‹µ í‘œì‹œ -->
        <div id="answer-display" class="answer-display"></div>

        <!-- GPT ì±„íŒ… -->
        <div class="chat-section">
          <div class="card-title">
            <i class="fas fa-robot"></i> AI ì–´ì‹œìŠ¤í„´íŠ¸
            <div class="chat-warning">
              <i class="fas fa-exclamation-triangle"></i> í€´ì¦ˆ ë¬¸ì œ ê´€ë ¨ ì§ˆë¬¸ì€ ë‹µë³€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
            </div>
          </div>
          <div id="chat-box" class="chat-box"></div>
          <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="í€´ì¦ˆì™€ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤..." />
            <button onclick="sendMessage()" class="send-btn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- ì‚¬ì´ë“œë°” -->
      <div class="sidebar">
        <!-- ìƒì¡´ì ë¦¬ìŠ¤íŠ¸ -->
        <div class="sidebar-card" id="survivor-box" style="display: none;">
          <div class="card-title">
            <i class="fas fa-trophy"></i> ìƒì¡´ì ë¦¬ìŠ¤íŠ¸
            <span id="survivor-count" class="survivor-badge">0</span>
          </div>
          <ul id="survivor-list" class="survivor-grid"></ul>
        </div>

        <!-- ê²Œì„ í†µê³„ -->
        <div class="sidebar-card">
          <div class="card-title">
            <i class="fas fa-chart-bar"></i> ê²Œì„ í˜„í™©
          </div>
          <div class="stat-item">
            <span>í˜„ì¬ ë¼ìš´ë“œ:</span>
            <span id="current-round">ì¤€ë¹„ ì¤‘</span>
          </div>
          <div class="stat-item">
            <span>ì´ ì°¸ì—¬ì:</span>
            <span id="total-participants">0ëª…</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… NEW: ë¼ìš´ë“œ ê²°ê³¼ í†µí•© ëª¨ë‹¬ -->
  <div id="result-modal" class="result-modal" style="display: none;">
    <div class="result-content">
      <div class="result-header">
        <h2 id="result-title">ğŸ‰ ë¼ìš´ë“œ ê²°ê³¼ ë°œí‘œ</h2>
      </div>
      
      <div class="result-question">
        <div class="question-label">ğŸ“ ë¬¸ì œ</div>
        <div id="result-question-text">ë¬¸ì œ ë‚´ìš©</div>
      </div>
      
      <div class="result-answer">
        <div class="answer-label">ì •ë‹µ</div>
        <div id="result-answer-text">O</div>
      </div>
      
      <div class="result-stats">
        <div class="stats-header">ğŸ“Š ì´ë²ˆ ë¼ìš´ë“œ</div>
        <div class="progress-container">
          <div class="progress-bar-large">
            <div id="result-progress" class="progress-fill-large"></div>
          </div>
          <div id="result-rate" class="progress-text">67% ì •ë‹µ (132/197ëª…)</div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-icon">ğŸ‘‘</div>
            <div class="stat-label">ìƒì¡´ì</div>
            <div id="result-survivors" class="stat-value">132ëª…</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ’€</div>
            <div class="stat-label">íƒˆë½ì</div>
            <div id="result-eliminated" class="stat-value">65ëª…</div>
          </div>
          <div class="stat-item">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-label">ì •ë‹µë¥ </div>
            <div id="result-percentage" class="stat-value">67%</div>
          </div>
        </div>
      </div>
      
      <div class="result-explanation">
        <div class="explanation-header">ğŸ§  í•´ì„¤</div>
        <div id="result-explanation-text" class="explanation-content">
          í•´ì„¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
        </div>
      </div>
      
      <div class="result-actions">
        <button onclick="closeResultModal()" class="result-btn">
          <i class="fas fa-check"></i> ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„
        </button>
      </div>
    </div>
  </div>
  <div id="draw-modal" class="draw-modal" style="display: none;">
    <div class="draw-content">
      <div class="draw-animation">
        <i class="fas fa-gift"></i>
      </div>
      <h2>ğŸ‰ ì¶”ì²¨ ê²°ê³¼ ë°œí‘œ!</h2>
      <div id="draw-winners" class="draw-winners"></div>
      <button onclick="closeDraw()" class="draw-close-btn">
        <i class="fas fa-check"></i> í™•ì¸
      </button>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
  <div id="toast" class="toast"></div>

  <!-- âœ… NEW: íŒŒí‹°í´ íš¨ê³¼ ì»¨í…Œì´ë„ˆ -->
  <div id="particles-container"></div>

  <script>
    const socket = io();
    let alreadyShownSurvivorMessage = false;

    // âœ… NEW: ì¶”ì²¨ ì‹œì‘ ì•Œë¦¼
    socket.on('drawingStarted', (data) => {
      showToast('ğŸ² ì¶”ì²¨ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!', 'info');
    });

    function showRoundResultModal(data) {
  console.log('ğŸ­ ëª¨ë‹¬ í‘œì‹œ ì‹œì‘:', data);
  
  const modal = document.getElementById('result-modal');
  if (!modal) {
    console.error('âŒ result-modal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    return;
  }
  
  const stats = data.stats;
  if (!stats) {
    console.error('âŒ stats ë°ì´í„° ì—†ìŒ, ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬');
    const answerDisplay = document.getElementById('answer-display');
    answerDisplay.innerText = `âœ… ì •ë‹µ: ${data.answer}`;
    answerDisplay.classList.add('show');
    return;
  }
  
  try {
    // ì œëª© ì—…ë°ì´íŠ¸
    document.getElementById('result-title').textContent = `ğŸ‰ ${data.round || ''}ë¼ìš´ë“œ ê²°ê³¼ ë°œí‘œ`;
    
    // ë¬¸ì œ í‘œì‹œ
    document.getElementById('result-question-text').textContent = data.question || 'ë¬¸ì œ ì—†ìŒ';
    
    // ì •ë‹µ í‘œì‹œ
    const answerElement = document.getElementById('result-answer-text');
    answerElement.textContent = data.answer || 'X';
    answerElement.className = `answer-badge ${(data.answer || 'x').toLowerCase()}-answer`;
    
    // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
    const progressBar = document.getElementById('result-progress');
    const progressText = document.getElementById('result-rate');
    
    progressBar.style.width = `${stats.correctRate || 0}%`;
    progressText.textContent = `${stats.correctRate || 0}% ì •ë‹µ (${stats.correctCount || 0}/${stats.totalParticipants || 0}ëª…)`;
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    document.getElementById('result-survivors').textContent = `${stats.correctCount || 0}ëª…`;
    document.getElementById('result-eliminated').textContent = `${stats.incorrectCount || 0}ëª…`;
    document.getElementById('result-percentage').textContent = `${stats.correctRate || 0}%`;
    
    // âœ… í•´ì„¤ í‘œì‹œ ê°œì„ 
    const explanationElement = document.getElementById('result-explanation-text');
    const explanationContainer = document.querySelector('.result-explanation');
    
    if (data.explanation && data.explanation.trim() && data.explanation !== 'í•´ì„¤ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') {
      explanationElement.textContent = data.explanation;
      explanationContainer.style.display = 'block';
    } else {
      // í•´ì„¤ì´ ì—†ìœ¼ë©´ í•´ì„¤ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      explanationContainer.style.display = 'none';
    }
    
    // ëª¨ë‹¬ í‘œì‹œ
    console.log('ğŸ­ ëª¨ë‹¬ í‘œì‹œ ì¤‘...');
    modal.style.display = 'flex';
    
    // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ ì•½ê°„ì˜ ë”œë ˆì´
    setTimeout(() => {
      modal.classList.add('show');
      console.log('âœ¨ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ');
    }, 10);
    
  } catch (error) {
    console.error('âŒ ëª¨ë‹¬ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
    // í´ë°±: ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì •ë‹µ í‘œì‹œ
    const answerDisplay = document.getElementById('answer-display');
    answerDisplay.innerText = `âœ… ì •ë‹µ: ${data.answer}`;
    answerDisplay.classList.add('show');
  }
}

   function closeResultModal() {
  const modal = document.getElementById('result-modal');
  modal.classList.remove('show');
  setTimeout(() => {
    modal.style.display = 'none';
  }, 300);
  
  // âœ… ë¬¸ì œ í…ìŠ¤íŠ¸ë¥¼ "ë¼ìš´ë“œ ì¤€ë¹„ì¤‘"ìœ¼ë¡œ ë³€ê²½
  document.getElementById('question-box').innerText = 'ğŸ¯ ë¼ìš´ë“œ ì¤€ë¹„ì¤‘...';
  document.getElementById('answer-display').innerText = '';
  document.getElementById('answer-display').classList.remove('show');

    // âœ… NEW: ì¶”ì²¨ ê²°ê³¼ í‘œì‹œ
    socket.on('drawingResult', (data) => {
      showDrawResult(data.winners);
    });

    // âœ… NEW: ê²Œì„ ì´ˆê¸°í™” ì´ë²¤íŠ¸ ì²˜ë¦¬
    socket.on('reset', () => {
      // í˜ì´ì§€ ìƒíƒœ ì´ˆê¸°í™”
      document.getElementById('question-box').innerText = 'ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê²Œì„ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
      document.getElementById('answer-display').innerText = '';
      document.getElementById('answer-display').classList.remove('show');
      document.getElementById('participant-count').innerText = 'í˜„ì¬ ì°¸ì—¬ì ìˆ˜: 0ëª…';
      document.getElementById('current-round').innerText = 'ì¤€ë¹„ ì¤‘';
      document.getElementById('total-participants').innerText = '0ëª…';
      
      // ìƒì¡´ì ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
      document.getElementById('survivor-box').style.display = 'none';
      
      // ì‚¬ìš©ì ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById('username').value = '';
      
      // ì±„íŒ…ì°½ ì´ˆê¸°í™”
      const chatBox = document.getElementById('chat-box');
      chatBox.innerHTML = '<div class="chat-message bot"><i class="fas fa-robot"></i> ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê²Œì„ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”! ğŸ®</div>';
      
      // ì•Œë¦¼ í‘œì‹œ
      showToast('ğŸ”„ ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', 'info');
      
      // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
      alreadyShownSurvivorMessage = false;
    });

    // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    socket.on('newQuestion', (data) => {
      document.getElementById('question-box').innerText = data.question;
      document.getElementById('answer-display').innerText = '';
      document.getElementById('answer-display').classList.remove('show');
      document.getElementById('participant-count').innerText = 'í˜„ì¬ ì°¸ì—¬ì ìˆ˜: 0ëª…';
      alreadyShownSurvivorMessage = false;
      
      // ë¼ìš´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
      if (data.round) {
        const currentRoundElement = document.getElementById('current-round');
        if (currentRoundElement) {
          currentRoundElement.innerText = `${data.round}ë¼ìš´ë“œ`;
        }
      }
      
      // ìƒˆ ë¬¸ì œ ì• ë‹ˆë©”ì´ì…˜
      const questionContainer = document.querySelector('.question-container');
      questionContainer.style.animation = 'none';
      setTimeout(() => {
        questionContainer.style.animation = 'bounce 0.6s ease';
      }, 10);
      
      // ë¼ìš´ë“œ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
      setTimeout(() => {
        loadQuestion();
      }, 100);
    });

    socket.on('participantCount', (count) => {
      console.log('ì°¸ì—¬ì ìˆ˜ ì—…ë°ì´íŠ¸:', count);
      document.getElementById('participant-count').innerText = `í˜„ì¬ ì°¸ì—¬ì ìˆ˜: ${count}ëª…`;
      const totalElement = document.getElementById('total-participants');
      if (totalElement) {
        totalElement.innerText = `${count}ëª…`;
      }
    });

    socket.on('roundEnded', (data) => {
      console.log('ğŸ¯ ë¼ìš´ë“œ ì¢…ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
      
      // âœ… ê¸°ì¡´ ì •ë‹µ í‘œì‹œëŠ” ì œê±°í•˜ê³  í†µí•© íŒì—…ìœ¼ë¡œ ëŒ€ì²´
      if (data.stats) {
        // ìƒˆë¡œìš´ í˜•ì‹ (í•´ì„¤ í¬í•¨)
        showRoundResultModal(data);
      } else {
        // ê¸°ì¡´ í˜•ì‹ í˜¸í™˜ì„±
        const answerDisplay = document.getElementById('answer-display');
        answerDisplay.innerText = `âœ… ì •ë‹µ: ${data.answer}`;
        answerDisplay.classList.add('show');
      }
      
      if (alreadyShownSurvivorMessage) return;
      alreadyShownSurvivorMessage = true;

      renderSurvivors(data.survivors);
    });

    socket.on('survivors', (data) => {
      console.log('ğŸ‘‘ ìƒì¡´ì ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
      renderSurvivors(data.survivors);
      
      // âœ… ìƒì¡´ì ì •ë³´ ê°•ì œ ì—…ë°ì´íŠ¸
      alreadyShownSurvivorMessage = false; // í”Œë˜ê·¸ ë¦¬ì…‹ìœ¼ë¡œ ë‹¤ì‹œ í‘œì‹œ ê°€ëŠ¥í•˜ê²Œ
    });

    socket.on('connect', () => {
      console.log('âœ… ì„œë²„ì— ì—°ê²°ë¨ - Socket ID:', socket.id);
      setTimeout(() => {
        loadQuestion();
        loadSurvivors();
      }, 100);
    });

    // âœ… NEW: ì—°ê²° ëŠê¹€ ì²˜ë¦¬
    socket.on('disconnect', () => {
      showToast('âš ï¸ ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...', 'warning');
    });

    // âœ… NEW: ì¬ì—°ê²° ì²˜ë¦¬
    socket.on('reconnect', () => {
      showToast('âœ… ì„œë²„ì— ë‹¤ì‹œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      setTimeout(() => {
        loadQuestion();
        loadSurvivors();
      }, 500);
    });

    // âœ… NEW: ì¶”ì²¨ ê²°ê³¼ í‘œì‹œ
    function showDrawResult(winners) {
      const modal = document.getElementById('draw-modal');
      const winnersDiv = document.getElementById('draw-winners');
      
      winnersDiv.innerHTML = '';
      winners.forEach((winner, index) => {
        const winnerElement = document.createElement('div');
        winnerElement.className = 'winner-item';
        winnerElement.innerHTML = `<i class="fas fa-crown"></i> ${winner}`;
        winnerElement.style.animationDelay = `${index * 0.2}s`;
        winnersDiv.appendChild(winnerElement);
      });
      
      modal.style.display = 'flex';
      triggerParticles();
    }

    function closeDraw() {
      document.getElementById('draw-modal').style.display = 'none';
    }

    // âœ… NEW: íŒŒí‹°í´ íš¨ê³¼
    function triggerParticles() {
      const container = document.getElementById('particles-container');
      
      for (let i = 0; i < 30; i++) {
        setTimeout(() => {
          createParticle(container);
        }, i * 100);
      }
    }

    function createParticle(container) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.innerHTML = ['ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'âœ¨'][Math.floor(Math.random() * 5)];
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
      container.appendChild(particle);
      
      setTimeout(() => {
        container.removeChild(particle);
      }, 5000);
    }

    async function loadQuestion() {
  try {
    const res = await fetch('/question');
    const data = await res.json();
    
    // âœ… gameReady ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ í‘œì‹œ
    if (!data.gameReady && data.status === 'ended') {
      document.getElementById('question-box').innerText = 'ğŸ¯ ë¼ìš´ë“œ ì¤€ë¹„ì¤‘...';
    } else {
      document.getElementById('question-box').innerText = data.question || 'ë¬¸ì œ ì—†ìŒ';
    }
    
    const participantCount = data.participantCount || 0;
    document.getElementById('participant-count').innerText = `í˜„ì¬ ì°¸ì—¬ì ìˆ˜: ${participantCount}ëª…`;
    document.getElementById('total-participants').innerText = `${participantCount}ëª…`;
    
    const currentRoundElement = document.getElementById('current-round');
    if (currentRoundElement) {
      if (data.currentRound && data.currentRound > 0) {
        currentRoundElement.innerText = `${data.currentRound}ë¼ìš´ë“œ`;
      } else {
        currentRoundElement.innerText = 'ì¤€ë¹„ ì¤‘';
      }
    }
    
    console.log('ë¡œë“œëœ ë°ì´í„°:', { 
      participantCount, 
      currentRound: data.currentRound,
      status: data.status,
      gameReady: data.gameReady
    });
    
  } catch (error) {
    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    showToast('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

    async function loadSurvivors() {
      try {
        const res = await fetch('/question');
        const data = await res.json();
        const raw = data.survivors || '';
        const survivors = raw.split(',').map(name => name.trim()).filter(Boolean);
        renderSurvivors(survivors);
      } catch (error) {
        console.error('ìƒì¡´ì ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    function renderSurvivors(survivors) {
      const box = document.getElementById('survivor-box');
      const list = document.getElementById('survivor-list');
      const count = document.getElementById('survivor-count');

      if (!survivors || survivors.length === 0) {
        box.style.display = 'none';
        return;
      }

      box.style.display = 'block';
      list.innerHTML = '';
      count.innerText = survivors.length;

      const displayLimit = 12;
      const visibleNames = survivors.slice(0, displayLimit);

      visibleNames.forEach((name, index) => {
        const li = document.createElement('li');
        li.className = 'survivor-item';
        li.textContent = name;
        li.style.animationDelay = `${index * 0.1}s`;
        list.appendChild(li);
      });

      if (survivors.length > displayLimit) {
        const li = document.createElement('li');
        li.className = 'survivor-item more';
        li.textContent = `ì™¸ ${survivors.length - displayLimit}ëª…`;
        list.appendChild(li);
      }
    }

    // ë‹µì•ˆ ì œì¶œ (í–¥ìƒëœ í”¼ë“œë°±)
    async function submitAnswer(answer) {
      const name = document.getElementById('username').value.trim();
      if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!', 'warning');
        document.getElementById('username').focus();
        return;
      }

      const button = event.target.closest('.answer-btn');
      button.style.pointerEvents = 'none';
      const originalContent = button.innerHTML;
      button.innerHTML = '<div class="loading"></div>';

      try {
        const res = await fetch('/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, answer })
        });

        if (res.status === 409) {
          showToast('ì´ë¯¸ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤!', 'warning');
        } else if (res.status === 403) {
          showToast('ìƒì¡´ìë§Œ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        } else {
          showToast(`${answer} ë‹µì•ˆì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
          // âœ… ì„±ê³µ ì‹œ íŒŒí‹°í´ íš¨ê³¼
          createSubmitParticles(button);
        }
      } catch (err) {
        showToast('ì„œë²„ ì˜¤ë¥˜: ì œì¶œ ì‹¤íŒ¨', 'error');
        console.error(err);
      } finally {
        setTimeout(() => {
          button.innerHTML = originalContent;
          button.style.pointerEvents = 'auto';
        }, 1000);
      }
    }

    // âœ… NEW: ì œì¶œ ì„±ê³µ ì‹œ íŒŒí‹°í´ íš¨ê³¼
    function createSubmitParticles(button) {
      const rect = button.getBoundingClientRect();
      const container = document.getElementById('particles-container');
      
      for (let i = 0; i < 8; i++) {
        const particle = document.createElement('div');
        particle.className = 'submit-particle';
        particle.style.left = rect.left + rect.width/2 + 'px';
        particle.style.top = rect.top + rect.height/2 + 'px';
        particle.style.setProperty('--dx', (Math.random() - 0.5) * 200 + 'px');
        particle.style.setProperty('--dy', (Math.random() - 0.5) * 200 + 'px');
        container.appendChild(particle);
        
        setTimeout(() => {
          if (container.contains(particle)) {
            container.removeChild(particle);
          }
        }, 1000);
      }
    }

    // GPT ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      const chat = document.getElementById('chat-box');
      
      const userMessage = document.createElement('div');
      userMessage.className = 'chat-message user';
      userMessage.innerHTML = `<i class="fas fa-user"></i> ${message}`;
      chat.appendChild(userMessage);
      chat.scrollTop = chat.scrollHeight;

      const loadingMessage = document.createElement('div');
      loadingMessage.className = 'chat-message bot';
      loadingMessage.innerHTML = `<i class="fas fa-robot"></i> <div class="loading"></div> ë‹µë³€ì„ ìƒê°í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
      chat.appendChild(loadingMessage);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch('/ask-gpt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const data = await res.json();
        
        chat.removeChild(loadingMessage);
        
        const botMessage = document.createElement('div');
        botMessage.className = 'chat-message bot';
        botMessage.innerHTML = `<i class="fas fa-robot"></i> ${data.reply}`;
        chat.appendChild(botMessage);
        chat.scrollTop = chat.scrollHeight;
      } catch (err) {
        chat.removeChild(loadingMessage);
        const errorMessage = document.createElement('div');
        errorMessage.className = 'chat-message bot';
        errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
        errorMessage.style.color = '#ff6b6b';
        chat.appendChild(errorMessage);
        chat.scrollTop = chat.scrollHeight;
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ì—”í„°í‚¤ ì´ë²¤íŠ¸
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    document.getElementById('username').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.querySelector('.answer-btn').focus();
      }
    });

    // ì´ˆê¸°í™”
    window.onload = () => {
      loadQuestion();
      loadSurvivors();
      showToast('SK AX OX í€´ì¦ˆì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰', 'success');
      
      setTimeout(() => {
        loadQuestion();
      }, 1000);
    };
  </script>
</body>
</html>
